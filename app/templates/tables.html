{% extends "base.html" %}

{% block title %}Data Tables - DataConsole{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="page-header">
        <h1>Database Tables Management</h1>
        <p>Browse, edit, and manage your database tables with advanced data operations</p>
    </div>

    <div class="tables-container">
        <div class="table-selector">
            <h3>Select Table</h3>
            <div class="table-tabs">
                {% for table in all_tables %}
                <a href="/tables?table={{ table }}" 
                   class="table-tab {% if selected_table == table %}active{% endif %}">
                    {{ table }}
                </a>
                {% endfor %}
            </div>
        </div>

        {% if selected_table %}
        <div class="table-content">
            <div class="table-info">
                <div>
                    <h2>{{ selected_table }}</h2>
                    <p class="text-secondary">PostgreSQL database table</p>
                </div>
                <div class="table-stats">
                    <div class="stat-item">
                        <span class="stat-label">Total Records</span>
                        <span class="stat-number">{{ total_rows }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Columns</span>
                        <span class="stat-number">{{ columns|length }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Current Page</span>
                        <span class="stat-number">{{ current_page }}</span>
                    </div>
                </div>
            </div>

            <div class="table-actions mb-2">
                <div class="btn-group">
                    <button onclick="exportTable('excel')" class="btn btn-success">
                        <span class="icon">üìä</span>
                        Export to Excel
                    </button>
                    <button onclick="exportTable('json')" class="btn btn-secondary">
                        <span class="icon">üìÑ</span>
                        Export to JSON
                    </button>
                    <button onclick="showTableStructure()" class="btn btn-secondary">
                        <span class="icon">üîç</span>
                        View Structure
                    </button>
                </div>
            </div>

            {% if total_pages > 1 %}
            <div class="pagination mb-2">
                {% if current_page > 1 %}
                <a href="/tables?table={{ selected_table }}&page=1" class="page-link">First</a>
                <a href="/tables?table={{ selected_table }}&page={{ current_page - 1 }}" class="page-link">Previous</a>
                {% endif %}
                
                <span class="page-info">Page {{ current_page }} of {{ total_pages }}</span>
                
                {% if current_page < total_pages %}
                <a href="/tables?table={{ selected_table }}&page={{ current_page + 1 }}" class="page-link">Next</a>
                <a href="/tables?table={{ selected_table }}&page={{ total_pages }}" class="page-link">Last</a>
                {% endif %}
            </div>
            {% endif %}

            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            {% for col in columns %}
                            <th>{{ col.column_name }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data %}
                        <tr>
                            {% for col in columns %}
                            <td>
                                {% if row[col.column_name] is none %}
                                <span class="null-value">NULL</span>
                                {% else %}
                                {{ row[col.column_name] }}
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if total_pages > 1 %}
            <div class="pagination mt-2">
                {% if current_page > 1 %}
                <a href="/tables?table={{ selected_table }}&page=1" class="page-link">First</a>
                <a href="/tables?table={{ selected_table }}&page={{ current_page - 1 }}" class="page-link">Previous</a>
                {% endif %}
                
                <span class="page-info">Page {{ current_page }} of {{ total_pages }}</span>
                
                {% if current_page < total_pages %}
                <a href="/tables?table={{ selected_table }}&page={{ current_page + 1 }}" class="page-link">Next</a>
                <a href="/tables?table={{ selected_table }}&page={{ total_pages }}" class="page-link">Last</a>
                {% endif %}
            </div>
            {% endif %}

            <div class="operations-grid mt-2">
                <div class="operation-card">
                    <h3><span class="icon">‚ûï</span> Insert New Record</h3>
                    <form id="insertForm" onsubmit="return insertRecord(event)">
                        <input type="hidden" name="table" value="{{ selected_table }}">
                        <div class="form-group">
                            <label class="form-label">Data Fields (JSON Format)</label>
                            <textarea name="row_data" class="form-control" rows="6" 
                                      placeholder='{"column1": "value1", "column2": "value2"}'
                                      required></textarea>
                            <span class="form-hint">Enter data as JSON object with column names as keys</span>
                        </div>
                        <button type="submit" class="btn btn-success w-full">
                            <span class="icon">‚úì</span>
                            Insert Record
                        </button>
                    </form>
                </div>

                <div class="operation-card">
                    <h3><span class="icon">‚úèÔ∏è</span> Update Existing Records</h3>
                    <form id="updateForm" onsubmit="return updateRecords(event)">
                        <input type="hidden" name="table" value="{{ selected_table }}">
                        <div class="form-group">
                            <label class="form-label">WHERE Condition</label>
                            <input type="text" name="filter_condition" class="form-control" 
                                   placeholder="id = 1 OR status = 'active'" required>
                            <span class="form-hint">SQL WHERE clause to select records for update</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Update Data (JSON)</label>
                            <textarea name="update_data" class="form-control" rows="4"
                                      placeholder='{"status": "inactive", "updated_at": "now()"}'></textarea>
                            <span class="form-hint">Columns to update with new values</span>
                        </div>
                        <button type="submit" class="btn btn-warning w-full">
                            <span class="icon">üîÑ</span>
                            Update Records
                        </button>
                    </form>
                </div>

                <div class="operation-card">
                    <h3><span class="icon">üóëÔ∏è</span> Delete Records</h3>
                    <form id="deleteForm" onsubmit="return deleteRecords(event)">
                        <input type="hidden" name="table" value="{{ selected_table }}">
                        <div class="form-group">
                            <label class="form-label">WHERE Condition</label>
                            <input type="text" name="filter_condition" class="form-control" 
                                   placeholder="id = 1 AND status = 'obsolete'" required>
                            <span class="form-hint">SQL WHERE clause to select records for deletion</span>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="cascade_mode" name="cascade_mode">
                            <label for="cascade_mode" class="form-label">Cascade Delete</label>
                        </div>
                        <span class="form-hint text-danger">‚ö†Ô∏è Cascade will delete related records in other tables</span>
                        <button type="submit" class="btn btn-danger w-full mt-2">
                            <span class="icon">‚ö†Ô∏è</span>
                            Delete Records
                        </button>
                    </form>
                </div>
            </div>
        </div>
        {% else %}
        <div class="table-content">
            <div class="message info">
                <h3>No Table Selected</h3>
                <p>Please select a table from the list above to view and manage its data.</p>
                <p>If no tables are listed, your database might be empty or not properly connected.</p>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="results-panel hidden" id="resultsPanel">
        <div class="results-header">
            <h3>Operation Results</h3>
            <button onclick="closeResultsPanel()" class="btn btn-sm btn-secondary">Close</button>
        </div>
        <div id="resultsContent"></div>
    </div>
</div>

<script>
function exportTable(format) {
    const table = '{{ selected_table }}';
    if (table) {
        window.open(`/api/export/table/${table}/${format}`, '_blank');
    } else {
        alert('Please select a table first');
    }
}

async function showTableStructure() {
    const table = '{{ selected_table }}';
    if (!table) {
        alert('Please select a table first');
        return;
    }
    
    const panel = document.getElementById('resultsPanel');
    const content = document.getElementById('resultsContent');
    
    content.innerHTML = '<div class="message loading">Loading table structure...</div>';
    panel.classList.remove('hidden');
    
    try {
        const response = await fetch(`/api/tables/${table}/structure`);
        const data = await response.json();
        
        if (data.status === 'success') {
            let structureHTML = '<div class="message info">';
            structureHTML += '<h4>Table Structure: ' + table + '</h4>';
            structureHTML += '<table class="data-table mt-2">';
            structureHTML += '<thead><tr><th>Column</th><th>Type</th><th>Nullable</th><th>Default</th></tr></thead>';
            structureHTML += '<tbody>';
            
            data.data.structure.forEach(col => {
                structureHTML += `<tr>
                    <td><strong>${col.column_name}</strong></td>
                    <td><code>${col.data_type}</code></td>
                    <td>${col.is_nullable}</td>
                    <td>${col.column_default || '‚Äî'}</td>
                </tr>`;
            });
            
            structureHTML += '</tbody></table></div>';
            content.innerHTML = structureHTML;
        } else {
            content.innerHTML = `
                <div class="message error">
                    <strong>Error Loading Structure</strong>
                    <p>${data.error || 'Unknown error occurred'}</p>
                </div>
            `;
        }
    } catch (error) {
        content.innerHTML = `
            <div class="message error">
                <strong>Connection Error</strong>
                <p>${error.message}</p>
            </div>
        `;
    }
}

async function insertRecord(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    
    const panel = document.getElementById('resultsPanel');
    const content = document.getElementById('resultsContent');
    
    content.innerHTML = '<div class="message loading">Inserting record...</div>';
    panel.classList.remove('hidden');
    
    try {
        const response = await fetch(`/api/tables/${formData.get('table')}/data`, {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({
                row_data: formData.get('row_data')
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            content.innerHTML = `
                <div class="message success">
                    <strong>‚úÖ Record Inserted Successfully</strong>
                    <p>${data.message}</p>
                    <p class="mt-2">Inserted ID: <strong>${data.data.inserted_id}</strong></p>
                </div>
            `;
            setTimeout(() => location.reload(), 2000);
        } else {
            content.innerHTML = `
                <div class="message error">
                    <strong>‚ùå Insertion Failed</strong>
                    <p>${data.error || 'Unknown error occurred'}</p>
                </div>
            `;
        }
    } catch (error) {
        content.innerHTML = `
            <div class="message error">
                <strong>‚ùå Request Failed</strong>
                <p>${error.message}</p>
            </div>
        `;
    }
}

async function updateRecords(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    
    if (!confirm('Update records with the specified condition? This action cannot be undone.')) {
        return;
    }
    
    const panel = document.getElementById('resultsPanel');
    const content = document.getElementById('resultsContent');
    
    content.innerHTML = '<div class="message loading">Updating records...</div>';
    panel.classList.remove('hidden');
    
    try {
        const response = await fetch(`/api/tables/${formData.get('table')}/data`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({
                update_data: formData.get('update_data'),
                filter_condition: formData.get('filter_condition')
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            content.innerHTML = `
                <div class="message success">
                    <strong>‚úÖ Records Updated Successfully</strong>
                    <p>${data.message}</p>
                </div>
            `;
            setTimeout(() => location.reload(), 2000);
        } else {
            content.innerHTML = `
                <div class="message error">
                    <strong>‚ùå Update Failed</strong>
                    <p>${data.error || 'Unknown error occurred'}</p>
                </div>
            `;
        }
    } catch (error) {
        content.innerHTML = `
            <div class="message error">
                <strong>‚ùå Request Failed</strong>
                <p>${error.message}</p>
            </div>
        `;
    }
}

async function deleteRecords(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const cascade = document.getElementById('cascade_mode').checked;
    
    let message = cascade 
        ? '‚ö†Ô∏è DANGER: Cascade delete will remove ALL related records from other tables.\n\nAre you absolutely sure?'
        : 'Delete records matching the specified condition? This action cannot be undone.';
    
    if (!confirm(message)) {
        return;
    }
    
    const panel = document.getElementById('resultsPanel');
    const content = document.getElementById('resultsContent');
    
    content.innerHTML = '<div class="message loading">Deleting records...</div>';
    panel.classList.remove('hidden');
    
    try {
        const response = await fetch(`/api/tables/${formData.get('table')}/data`, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({
                filter_condition: formData.get('filter_condition'),
                cascade_mode: cascade
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            content.innerHTML = `
                <div class="message success">
                    <strong>‚úÖ Records Deleted Successfully</strong>
                    <p>${data.message}</p>
                    <p class="mt-2">Affected rows: <strong>${data.data?.affected_rows || 'Unknown'}</strong></p>
                </div>
            `;
            setTimeout(() => location.reload(), 2000);
        } else {
            if (data.data?.has_dependencies) {
                let depMessage = '<div class="message warning"><strong>‚ö†Ô∏è Cannot Delete: Dependencies Found</strong><p>The following tables contain related records:</p><ul>';
                data.data.dependencies.forEach(dep => {
                    depMessage += `<li><strong>${dep.table}</strong>: ${dep.count} related records</li>`;
                });
                depMessage += '</ul><p>Use cascade delete to remove all related records.</p></div>';
                content.innerHTML = depMessage;
            } else {
                content.innerHTML = `
                    <div class="message error">
                        <strong>‚ùå Deletion Failed</strong>
                        <p>${data.error || 'Unknown error occurred'}</p>
                    </div>
                `;
            }
        }
    } catch (error) {
        content.innerHTML = `
            <div class="message error">
                <strong>‚ùå Request Failed</strong>
                <p>${error.message}</p>
            </div>
        `;
    }
}

function closeResultsPanel() {
    document.getElementById('resultsPanel').classList.add('hidden');
}
</script>
{% endblock %}