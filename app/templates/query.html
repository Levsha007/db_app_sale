{% extends "base.html" %}

{% block title %}Query Console - DataConsole{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="page-header">
        <h1>SQL Query Console</h1>
        <p>Execute SQL queries, analyze results, and export data with the advanced database console</p>
    </div>

    <div class="query-interface">
        <div class="query-editor-container">
            <div class="editor-header">
                <h3>SQL Query Editor</h3>
                <div class="query-tools">
                    <button onclick="formatSQL()" class="btn btn-sm btn-secondary">
                        <span class="icon">‚ú®</span>
                        Format SQL
                    </button>
                    <button onclick="clearQuery()" class="btn btn-sm btn-secondary">
                        <span class="icon">üóëÔ∏è</span>
                        Clear
                    </button>
                </div>
            </div>
            
            <div class="query-editor">
                <textarea id="queryText" class="query-textarea" 
                          placeholder="SELECT * FROM table_name WHERE condition = ? LIMIT 100"
                          rows="8">{% if request.query_params.get('table') %}SELECT * FROM {{ request.query_params.get('table') }} LIMIT 100{% endif %}</textarea>
            </div>
        </div>

        <div class="query-sidebar">
            <div class="query-examples">
                <h4>Quick Examples</h4>
                <div class="examples-list">
                    <button class="example-btn" onclick="loadExample('select_all')">
                        SELECT * FROM users LIMIT 50
                    </button>
                    <button class="example-btn" onclick="loadExample('select_where')">
                        SELECT * FROM products WHERE price > 100
                    </button>
                    <button class="example-btn" onclick="loadExample('join')">
                        SELECT u.*, o.total FROM users u JOIN orders o ON u.id = o.user_id
                    </button>
                    <button class="example-btn" onclick="loadExample('aggregate')">
                        SELECT category, COUNT(*), AVG(price) FROM products GROUP BY category
                    </button>
                    <button class="example-btn" onclick="loadExample('update')">
                        UPDATE users SET status = 'active' WHERE last_login > '2024-01-01'
                    </button>
                </div>
            </div>

            <div class="query-params">
                <h4>Query Parameters</h4>
                <div class="form-group">
                    <label class="form-label">Parameters (JSON)</label>
                    <textarea id="queryParams" class="form-control" rows="4" 
                              placeholder='["value1", 123] or {"param1": "value1"}'
                              spellcheck="false"></textarea>
                    <span class="form-hint">Use array for positional params, object for named params</span>
                </div>
                <div class="form-group">
                    <label class="form-label">Export Format</label>
                    <select id="exportFormat" class="form-control">
                        <option value="excel">Excel Spreadsheet</option>
                        <option value="json">JSON Document</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="btn-group w-full">
            <button onclick="executeQuery()" class="btn btn-primary btn-lg flex-1">
                <span class="icon">‚ö°</span>
                Execute Query
            </button>
            <button onclick="exportQuery()" class="btn btn-success btn-lg flex-1">
                <span class="icon">üì•</span>
                Export Results
            </button>
            <button onclick="explainQuery()" class="btn btn-secondary btn-lg flex-1">
                <span class="icon">üîç</span>
                Explain Plan
            </button>
        </div>
    </div>

    <div class="results-panel hidden" id="resultsPanel">
        <div class="results-header">
            <h3>Query Results</h3>
            <div class="btn-group">
                <button onclick="copyResults()" class="btn btn-sm btn-secondary">
                    <span class="icon">üìã</span>
                    Copy Table
                </button>
                <button onclick="closeResultsPanel()" class="btn btn-sm btn-secondary">
                    Close
                </button>
            </div>
        </div>
        
        <div class="results-meta mb-2" id="resultsMeta"></div>
        
        <div class="data-table-container">
            <table id="resultsTable" class="data-table">
                <!-- Results will be inserted here -->
            </table>
        </div>
    </div>

    <div class="results-panel hidden" id="explainPanel">
        <div class="results-header">
            <h3>Query Execution Plan</h3>
            <button onclick="closeExplainPanel()" class="btn btn-sm btn-secondary">Close</button>
        </div>
        <div id="explainContent"></div>
    </div>
</div>

<script>
const examples = {
    select_all: "SELECT * FROM users LIMIT 50",
    select_where: "SELECT * FROM products WHERE price > 100 AND category = %s",
    join: `SELECT 
    u.id,
    u.username,
    u.email,
    COUNT(o.id) as order_count,
    SUM(o.total) as total_spent
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
WHERE u.created_at > %s
GROUP BY u.id, u.username, u.email
ORDER BY total_spent DESC
LIMIT 100`,
    aggregate: `SELECT 
    category,
    COUNT(*) as product_count,
    AVG(price) as avg_price,
    MIN(price) as min_price,
    MAX(price) as max_price
FROM products
WHERE active = true
GROUP BY category
ORDER BY product_count DESC`,
    update: "UPDATE users SET status = 'active', last_active = NOW() WHERE last_login > %s"
};

function loadExample(exampleName) {
    const queryText = document.getElementById('queryText');
    const params = document.getElementById('queryParams');
    
    if (examples[exampleName]) {
        queryText.value = examples[exampleName];
        
        // Set appropriate parameters for the example
        if (exampleName === 'select_where') {
            params.value = '["electronics"]';
        } else if (exampleName === 'join' || exampleName === 'update') {
            params.value = '["2024-01-01"]';
        } else {
            params.value = '[]';
        }
        
        queryText.focus();
    }
}

function formatSQL() {
    const textarea = document.getElementById('queryText');
    let sql = textarea.value.trim();
    
    // Simple SQL formatting
    sql = sql
        .replace(/\b(SELECT|FROM|WHERE|JOIN|LEFT JOIN|RIGHT JOIN|INNER JOIN|GROUP BY|ORDER BY|LIMIT|UPDATE|SET|INSERT INTO|VALUES|DELETE FROM)\b/gi, '\n$1')
        .replace(/\b(AND|OR)\b/gi, '\n  $1')
        .replace(/,/g, ',\n  ')
        .replace(/\(\s+/g, '(')
        .replace(/\s+\)/g, ')');
    
    textarea.value = sql.trim();
}

function clearQuery() {
    if (confirm('Clear the query editor?')) {
        document.getElementById('queryText').value = '';
        document.getElementById('queryParams').value = '[]';
    }
}

async function executeQuery() {
    const query = document.getElementById('queryText').value.trim();
    const params = document.getElementById('queryParams').value.trim();
    
    if (!query) {
        alert('Please enter a SQL query');
        return;
    }
    
    const panel = document.getElementById('resultsPanel');
    const meta = document.getElementById('resultsMeta');
    const table = document.getElementById('resultsTable');
    
    panel.classList.remove('hidden');
    meta.innerHTML = '<div class="message loading">Executing query...</div>';
    table.innerHTML = '';
    
    const startTime = performance.now();
    
    try {
        let paramsObj = {};
        if (params) {
            try {
                paramsObj = JSON.parse(params);
            } catch (e) {
                meta.innerHTML = `<div class="message error">Invalid JSON parameters: ${e.message}</div>`;
                return;
            }
        }
        
        const response = await fetch('/api/query/execute', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({
                query_text: query,
                query_params: JSON.stringify(paramsObj)
            })
        });
        
        const data = await response.json();
        const endTime = performance.now();
        const executionTime = Math.round(endTime - startTime);
        
        if (data.status === 'success') {
            meta.innerHTML = `
                <div class="message success">
                    <div class="flex justify-between items-center">
                        <div>
                            <strong>‚úÖ Query Executed Successfully</strong>
                            <p>${data.message}</p>
                        </div>
                        <div class="text-right">
                            <div class="stat-label">Execution Time</div>
                            <div class="stat-number">${executionTime}ms</div>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2 mt-2">
                    <span class="stat-label">Rows Returned:</span>
                    <span class="stat-number">${data.data.row_count}</span>
                </div>
            `;
            
            displayResults(data.data.result);
        } else {
            meta.innerHTML = `
                <div class="message error">
                    <strong>‚ùå Query Execution Failed</strong>
                    <p>${data.error}</p>
                    <p class="mt-2">Execution time: ${executionTime}ms</p>
                </div>
            `;
        }
    } catch (error) {
        meta.innerHTML = `
            <div class="message error">
                <strong>‚ùå Connection Error</strong>
                <p>${error.message}</p>
            </div>
        `;
    }
}

async function exportQuery() {
    const query = document.getElementById('queryText').value.trim();
    const params = document.getElementById('queryParams').value.trim();
    const format = document.getElementById('exportFormat').value;
    
    if (!query) {
        alert('Please enter a SQL query');
        return;
    }
    
    try {
        let paramsObj = {};
        if (params) {
            try {
                paramsObj = JSON.parse(params);
            } catch (e) {
                alert(`Invalid JSON parameters: ${e.message}`);
                return;
            }
        }
        
        const formData = new FormData();
        formData.append('query_text', query);
        formData.append('query_params', JSON.stringify(paramsObj));
        formData.append('export_format', format);
        
        const response = await fetch('/api/export/query', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = `query_export_${new Date().toISOString().slice(0,10)}`;
            
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }
            
            if (format === 'excel') {
                filename = filename.replace(/\.xlsx$/, '.xlsx') || 'query_export.xlsx';
            } else if (format === 'json') {
                filename = filename.replace(/\.json$/, '.json') || 'query_export.json';
            }
            
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } else {
            const result = await response.json();
            alert(`Export failed: ${result.error || 'Unknown error'}`);
        }
    } catch (error) {
        alert(`Export error: ${error.message}`);
    }
}

async function explainQuery() {
    const query = document.getElementById('queryText').value.trim();
    
    if (!query) {
        alert('Please enter a SQL query');
        return;
    }
    
    const panel = document.getElementById('explainPanel');
    const content = document.getElementById('explainContent');
    
    panel.classList.remove('hidden');
    content.innerHTML = '<div class="message loading">Generating execution plan...</div>';
    
    try {
        const explainQuery = 'EXPLAIN (FORMAT JSON) ' + query;
        const response = await fetch('/api/query/execute', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({
                query_text: explainQuery,
                query_params: '{}'
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success' && data.data.result && data.data.result[0]) {
            const explainData = data.data.result[0]['QUERY PLAN'];
            let explainText = '';
            
            try {
                const plan = JSON.parse(explainData);
                explainText = formatExplainPlan(plan[0]['Plan']);
            } catch (e) {
                explainText = explainData;
            }
            
            content.innerHTML = `
                <div class="message info">
                    <h4>Query Execution Plan</h4>
                    <pre class="mt-2 p-2 bg-surface-alt rounded-lg overflow-auto">${explainText}</pre>
                </div>
            `;
        } else {
            content.innerHTML = `
                <div class="message error">
                    <strong>Failed to generate execution plan</strong>
                    <p>${data.error || 'No plan data returned'}</p>
                </div>
            `;
        }
    } catch (error) {
        content.innerHTML = `
            <div class="message error">
                <strong>Error generating plan</strong>
                <p>${error.message}</p>
            </div>
        `;
    }
}

function formatExplainPlan(plan, indent = 0) {
    let result = '';
    const spaces = '  '.repeat(indent);
    
    result += `${spaces}${plan['Node Type']}\n`;
    
    if (plan['Relation Name']) {
        result += `${spaces}  Table: ${plan['Relation Name']}\n`;
    }
    
    if (plan['Total Cost']) {
        result += `${spaces}  Cost: ${plan['Total Cost'].toFixed(2)}\n`;
    }
    
    if (plan['Plan Rows']) {
        result += `${spaces}  Estimated Rows: ${plan['Plan Rows']}\n`;
    }
    
    if (plan['Plans'] && Array.isArray(plan['Plans'])) {
        plan['Plans'].forEach(subPlan => {
            result += formatExplainPlan(subPlan, indent + 1);
        });
    }
    
    return result;
}

function displayResults(data) {
    const table = document.getElementById('resultsTable');
    
    if (!data || data.length === 0) {
        table.innerHTML = '<tr><td colspan="100" class="text-center p-8">No data returned from query</td></tr>';
        return;
    }
    
    const headers = Object.keys(data[0]);
    
    let html = '<thead><tr>';
    headers.forEach(header => {
        html += `<th>${header}</th>`;
    });
    html += '</tr></thead>';
    
    html += '<tbody>';
    data.forEach((row, index) => {
        html += '<tr>';
        headers.forEach(header => {
            let value = row[header];
            if (value === null || value === undefined) {
                value = '<span class="null-value">NULL</span>';
            } else if (typeof value === 'object') {
                value = '<span class="json-value">' + JSON.stringify(value, null, 2) + '</span>';
            } else if (typeof value === 'string' && value.length > 100) {
                value = '<span title="' + value + '">' + value.substring(0, 100) + '...</span>';
            } else if (typeof value === 'boolean') {
                value = value ? '‚úì' : '‚úó';
            }
            html += `<td>${value}</td>`;
        });
        html += '</tr>';
    });
    html += '</tbody>';
    
    table.innerHTML = html;
}

function copyResults() {
    const table = document.getElementById('resultsTable');
    let text = '';
    
    const headers = table.querySelectorAll('th');
    const headerText = Array.from(headers).map(th => th.textContent).join('\t');
    text += headerText + '\n';
    
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const rowText = Array.from(cells).map(cell => {
            let cellText = cell.textContent || cell.innerText;
            if (cellText.includes('NULL')) cellText = '';
            cellText = cellText.replace(/\n/g, ' ');
            return cellText;
        }).join('\t');
        text += rowText + '\n';
    });
    
    navigator.clipboard.writeText(text).then(() => {
        alert('Results copied to clipboard');
    });
}

function closeResultsPanel() {
    document.getElementById('resultsPanel').classList.add('hidden');
}

function closeExplainPanel() {
    document.getElementById('explainPanel').classList.add('hidden');
}
</script>

<style>
.json-value {
    font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
    font-size: 0.75rem;
    background: var(--surface-alt);
    padding: 2px 4px;
    border-radius: 4px;
    display: inline-block;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    vertical-align: middle;
}

.json-value:hover {
    overflow: visible;
    white-space: normal;
    position: relative;
    z-index: 100;
    background: var(--surface);
    border: 1px solid var(--border);
    box-shadow: var(--shadow-md);
}

.flex-1 {
    flex: 1;
}
</style>
{% endblock %}