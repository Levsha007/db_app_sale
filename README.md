# DB Admin Application

Веб-приложение для управления PostgreSQL базой данных с полным функционалом для работы с данными, выполнения SQL-запросов и сервисных операций.

## Основные функции

### 1. Управление данными

* Просмотр таблиц и данных
* CRUD операции (добавление, редактирование, удаление записей)
* Пагинация для больших таблиц
* Экспорт таблиц в Excel и JSON форматах

### 2. Конструктор SQL запросов

* Визуальный конструктор запросов
* Поддержка параметризованных запросов
* Примеры запросов для быстрого старта
* Выполнение EXPLAIN для анализа производительности
* Экспорт результатов запросов

### 3. Сервисные функции

* Полное резервное копирование базы данных
* Восстановление из бэкапов
* Архивация таблиц (бэкап + экспорт + удаление)
* Экспорт всех или выбранных таблиц
* Удаление таблиц с проверкой зависимостей

### 4. Безопасность

* Каскадное и безопасное удаление данных
* Проверка внешних ключей
* Подтверждение деструктивных операций
* Логирование сервисных операций

## Технический стек

* **Backend**: Python 3.9 + FastAPI
* **База данных**: PostgreSQL 15
* **Фронтенд**: HTML, CSS, JavaScript
* **Контейнеризация**: Docker + Docker Compose
* **Библиотеки**: psycopg2, pandas, openpyxl, Jinja2

## Структура проекта

```
project/
├── app/                          # Исходный код приложения
│   ├── static/                   # Статические файлы (CSS)
│   │   └── style.css
│   ├── templates/                # HTML шаблоны
│   │   ├── base.html            # Базовый шаблон
│   │   ├── index.html           # Главная страница
│   │   ├── data_forms.html      # Работа с данными
│   │   ├── query_builder.html   # Конструктор запросов
│   │   └── service.html         # Сервисные функции
│   ├── main.py                  # Основной FastAPI файл
│   ├── database.py              # Модуль работы с БД
│   ├── requirements.txt         # Зависимости Python
│   └── .env                     # Переменные окружения
├── database.backup              # Предварительный бэкап с данными
├── init.sql                     # SQL для инициализации пустой БД
├── docker-compose.yml           # Docker Compose конфигурация
├── Dockerfile                   # Docker образ приложения
├── README.md                    # Эта документация
├── .env                         # Переменные окружения (в корне)
└── .gitignore                   # Игнорируемые файлы Git
```

**Важно**: Рекомендуется создать файл `.env` как в корне проекта, так и в папке `app/` для корректной работы.

## Файл .env

Создайте файл `.env` в корне проекта и в папке `app/` со следующим содержанием:

```
# Параметры базы данных
DB_HOST=postgres
DB_PORT=5432
DB_NAME=my_app_db
DB_USER=postgres
DB_PASSWORD=postgres

# Параметры приложения
APP_HOST=0.0.0.0
APP_PORT=3000
```

## Начальная настройка

**ВАЖНО: При первом запуске база данных будет пустой.** Для загрузки тестовых данных необходимо:

1. Запустить приложение (база создастся пустой)
2. Перейти в раздел "Сервисные функции"
3. Использовать файл `database.backup` из корня проекта для восстановления
4. После восстановления база будет содержать тестовые данные

После восстановления из `database.backup` будут доступны следующие таблицы с данными:

1. **categories** - Категории закладок
2. **bookmarks** - Закладки с ссылками
3. **cities** - Города с координатами
4. **galleries** - Галереи изображений
5. **gallery_images** - Изображения в галереях
6. **quote_categories** - Категории цитат
7. **quotes** - Цитаты

## Установка и запуск

### Предварительные требования

* Docker Desktop (Windows/Mac) или Docker Engine (Linux)
* Git

### Запуск с помощью Docker

```bash
# Клонирование репозитория
git clone <repository-url>
cd <project-folder>

# Создание .env файлов
echo "DB_HOST=postgres" > .env
echo "DB_PORT=5432" >> .env
echo "DB_NAME=my_app_db" >> .env
echo "DB_USER=postgres" >> .env
echo "DB_PASSWORD=postgres" >> .env
echo "APP_HOST=0.0.0.0" >> .env
echo "APP_PORT=3000" >> .env

cp .env app/.env

# Запуск приложения
docker-compose up --build

# Приложение будет доступно по адресу:
# http://localhost:3000
```

### Первоначальная настройка данных

1. После запуска откройте [http://localhost:3000](http://localhost:3000)
2. Перейдите в раздел "Сервисные функции"
3. Нажмите "Восстановление из Backup"
4. Выберите файл `database.backup` из корня проекта
5. Подтвердите восстановление
6. После перезагрузки страницы данные будут загружены

### Основные команды Docker

```bash
# Запуск
docker-compose up --build

# Запуск в фоновом режиме
docker-compose up -d --build

# Остановка
docker-compose down

# Остановка с удалением данных
docker-compose down -v

# Просмотр логов
docker-compose logs -f

# Пересборка
docker-compose build --no-cache
docker-compose up

# Доступ к консоли контейнера
docker exec -it db_admin_app /bin/bash
```

### Ошибки при сборке

```bash
# Полная очистка и пересборка
docker-compose down -v
docker-compose build --no-cache
docker-compose up
```

## Работа с бэкапами

### Восстановление начальных данных

1. Используйте файл `database.backup` из корня проекта
2. В разделе "Сервисные функции" выберите этот файл
3. Нажмите "Восстановить БД"
4. **Внимание**: Все текущие данные будут заменены данными из бэкапа

### Создание новых бэкапов

1. Перейдите в раздел "Сервисные функции"
2. Нажмите "Создать полный Backup"
3. Файл будет сохранен в папке `backups/<дата_время>/`

### Архивация таблиц

1. Выберите таблицы для архивации
2. Будут созданы:

   * Бэкап в формате .backup
   * Экспорт в Excel (.xlsx)
   * Экспорт в JSON (.json)
3. Таблицы будут удалены из базы данных

## Особенности работы

### Каскадные операции

* При обновлении внешних ключей обновляются связанные таблицы
* При удалении с каскадом удаляются все зависимые записи
* Безопасное удаление проверяет наличие зависимостей

### Экспорт данных

* Поддерживается экспорт в Excel (с несколькими листами)
* Экспорт в JSON с сохранением структуры
* Экспорт результатов SQL-запросов
* Автоматическое разделение на страницы при большом объеме данных

### Безопасность

* Все деструктивные операции требуют подтверждения
* Проверка синтаксиса SQL-запросов
* Ограничение на количество возвращаемых записей
* Валидация входных параметров

## Форматы файлов

### Бэкапы

* Формат: PostgreSQL custom format (.backup)
* Содержимое: полная структура и данные БД
* Восстановление: только через pg_restore
* Начальный файл: `database.backup` в корне проекта

### Экспорты

* Excel: .xlsx с поддержкой нескольких листов
* JSON: структурированный формат с поддержкой Unicode

### Архивы

* Сохраняются в папке `archives/<дата_время>/`
* Включают бэкап, Excel и JSON версии
* Сопровождаются файлом metadata.json

## Устранение неполадок

### Приложение не запускается

1. Проверьте, что порт 3000 свободен
2. Убедитесь, что Docker запущен
3. Проверьте логи: `docker-compose logs -f app`

### Ошибки подключения к БД

1. Проверьте параметры в .env файле
2. Убедитесь, что контейнер PostgreSQL запущен
3. Проверьте логи БД: `docker-compose logs -f postgres`

### Проблемы с восстановлением из database.backup

1. Убедитесь, что файл `database.backup` существует в корне проекта
2. Проверьте размер файла (должен быть больше 0)
3. Убедитесь, что приложение полностью запущено перед восстановлением

### Данные не отображаются после восстановления

1. Обновите страницу приложения
2. Проверьте, что восстановление завершилось успешно
3. Проверьте логи: `docker-compose logs -f app`

## Рекомендации по использованию

### Для начала работы

1. Всегда начинайте с восстановления из `database.backup`
2. Создайте свой бэкап после настройки данных
3. Регулярно создавайте бэкапы перед изменениями структуры

### Для разработки

1. Используйте тестовую базу данных для экспериментов
2. Проверяйте SQL-запросы через EXPLAIN перед выполнением на production
3. Создавайте
